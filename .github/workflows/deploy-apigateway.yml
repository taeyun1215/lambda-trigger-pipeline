name: Deploy API Gateway

on:
  workflow_run:
    workflows: ["Deploy Lambda Function"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 저장소 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v2

      # API Gateway 생성 또는 업데이트 및 Lambda 통합
      - name: Create or Update API Gateway and Integrate with Lambda
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }} # ap-northeast-2
          LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }} # demo-lambda
          API_GATEWAY_NAME: ${{ secrets.API_GATEWAY_NAME }} # demo-gateway
        run: |
          # 변수 설정
          STAGE_NAME="prod"
          OPENAPI_FILE="openapi_base64.json"

          # S3에서 OpenAPI 파일 다운로드
          aws s3 cp s3://spring-aws-lambda/openapi_base64.json .

          # API Gateway ID 가져오기
          API_ID=$(aws apigateway get-rest-apis --query "items[?name=='${API_GATEWAY_NAME}'].id" --output text --region $AWS_REGION)

          echo "API_ID: ${API_ID}"

          if [ -z "$API_ID" ] || [ "$API_ID" == "None" ]; then
            echo "Creating new API Gateway..."
            # API Gateway 생성
            API_BODY=$(cat ${OPENAPI_FILE})
            API_ID=$(aws apigateway import-rest-api --body "$API_BODY" --query 'id' --output text --region $AWS_REGION)
          else
            echo "Updating existing API Gateway..."
            # API Gateway 업데이트
            API_BODY=$(cat ${OPENAPI_FILE})
            aws apigateway put-rest-api --rest-api-id $API_ID --mode overwrite --body "$API_BODY" --region $AWS_REGION
          fi

          # API Gateway 이름 설정 (생성 후 및 업데이트 후 모두)
          aws apigateway update-rest-api --rest-api-id $API_ID --patch-operations op=replace,path=/name,value="${API_GATEWAY_NAME}" --region $AWS_REGION

          echo "Updated API_ID: ${API_ID}"

          # API Gateway 경로 및 메서드 가져오기
          RESOURCE_IDS=$(aws apigateway get-resources --rest-api-id $API_ID --query "items[].id" --output text --region $AWS_REGION)
          echo "RESOURCE_IDS: ${RESOURCE_IDS}"

          for RESOURCE_ID in $RESOURCE_IDS; do
            echo "Processing RESOURCE_ID: ${RESOURCE_ID}"
            RESOURCE=$(aws apigateway get-resource --rest-api-id $API_ID --resource-id $RESOURCE_ID --region $AWS_REGION)
            RESOURCE_PATH=$(echo $RESOURCE | jq -r '.path')
            if [ "$(echo $RESOURCE | jq '.resourceMethods')" != "null" ]; then
              METHODS=$(echo $RESOURCE | jq -r '.resourceMethods | keys | @tsv')
              echo "METHODS raw output: ${METHODS}"
              if [ -z "$METHODS" ] || [ "$METHODS" == "None" ] || [ "$METHODS" == "null" ]; then
                echo "No methods found for RESOURCE_ID: ${RESOURCE_ID}"
                continue
              fi
              echo "METHODS for RESOURCE_ID ${RESOURCE_ID}: ${METHODS}"
              for METHOD in $METHODS; do
                echo "Adding integration for METHOD: ${METHOD} on RESOURCE_ID: ${RESOURCE_ID}"
                # Lambda 통합 추가
                aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $METHOD \
                  --type AWS_PROXY --integration-http-method POST \
                  --uri arn:aws:apigateway:${AWS_REGION}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS_REGION}:$(aws sts get-caller-identity --query "Account" --output text):function:${LAMBDA_FUNCTION_NAME}/invocations \
                  --region $AWS_REGION

                # Lambda 권한 추가
                aws lambda add-permission --function-name $LAMBDA_FUNCTION_NAME \
                  --statement-id "apigateway-$(uuidgen)" \
                  --action "lambda:InvokeFunction" \
                  --principal apigateway.amazonaws.com \
                  --source-arn "arn:aws:execute-api:${AWS_REGION}:$(aws sts get-caller-identity --query "Account" --output text):${API_ID}/*/${METHOD}${RESOURCE_PATH}"
              done
            else
              echo "No methods found for RESOURCE_ID: ${RESOURCE_ID}"
            fi
          done

          # 배포
          aws apigateway create-deployment --rest-api-id $API_ID --stage-name $STAGE_NAME --region $AWS_REGION
